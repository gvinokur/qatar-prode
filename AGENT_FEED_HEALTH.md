# Feed Health & Monitoring Knowledge Base - Indeed AggOps

This document contains comprehensive knowledge about Indeed's feed health monitoring system, sourced from internal Confluence documentation.

## Overview

Indeed's feed health system is a comprehensive monitoring infrastructure that automatically detects, reports, and manages feed quality issues across the job aggregation pipeline. The system prevents broken feeds from impacting job seekers and employers through automated detection and remediation workflows.

## Core System Components

### 1. **AggMonitor (AggMon)**

**Purpose**: The central monitoring system that tracks feed health and automatically manages feed error states.

**Key Functions**:
- Monitors feed health using heuristic-based rules
- Automatically puts feeds into/out of error status
- Creates SHLK tickets when feeds become unhealthy
- Updates feed health status in real-time
- Manages auto-close functionality for resolved issues

**Technical Implementation**:
- Uses IQL (Indeed Query Language) for heuristic definitions
- Processes feed run data, job metrics, and system logs
- Operates on time-based lookback windows (1-30 days)
- Integrates with multiple data indexes (feedrun, searchablejobs, etc.)

### 2. **SHLK Tickets (Sherlock)**

**Definition**: Automated tickets created when feeds fail health checks.

**Lifecycle Management**:
- **Creation**: Automatically generated by AggMon when heuristics trigger
- **Assignment**: Routed to AggHealth Support Specialists
- **Investigation**: Following heuristic-specific guidelines
- **Resolution**: Manual fixes or escalation to Feed Maintenance
- **Closure**: Manual closure or auto-close when conditions resolve

**Labeling System**:
- Each heuristic adds specific labels (e.g., `start_mod`, `jlink_mod`, `end_in_error`)
- Labels enable filtering, reporting, and automated workflows
- Historical tracking for repeat issues and false positive identification

### 3. **Heuristics (Feed Health Rules)**

**Definition**: Automated rules that detect specific types of feed problems using statistical analysis and pattern recognition.

**Characteristics**:
- **Edge-triggered**: Some heuristics only fire when conditions change
- **Threshold-based**: Use statistical analysis to minimize false positives
- **Time-bounded**: Operate within specific lookback windows
- **Exclusion-aware**: Skip feeds with known issues or recent investigations

## Critical Feed Health Heuristics

### **Start Page Error**
```sql
-- Detects HTTP errors on feed start URLs
FROM feedrun 2d tomorrow
WHERE feedid NOT IN (exclusion_logic)
GROUP BY feedid HAVING 
  start_page_error =~ 'http[4-7].*' = COUNT()
  AND queued_job_count = 0
```

**Configuration**:
- **Lookback**: 2 days
- **Autoclose**: YES
- **Exclusions**: Feeds with Ignore HTTP Error FLA
- **Error Codes**: 4xx (client errors), 5xx (server errors)

**Common Causes**:
- Site blocking IndeedBot user agent
- Invalid authentication credentials
- Server downtime or maintenance
- URL structure changes

### **End in Error**
```sql
-- Detects processing exceptions on all runs
FROM feedrun 2d tomorrow
WHERE exclusion_criteria
GROUP BY feedid HAVING 
  run_exception='FEED'=COUNT()
```

**Configuration**:
- **Lookback**: 2 days
- **Autoclose**: YES
- **Pattern**: All runs ending in FEED exception
- **Impact**: Complete feed failure

### **Job Link Hit/Miss (JL Hit/JD Miss)**
```sql
-- Job list works but job details fail
FROM feedrun 8d tomorrow
WHERE feed_type="agg3" 
  AND (feed_fla_values_tok="Update-1" + group_fla_values_tok="Update-1" > 0)
  AND (feed_fla_values_tok="CompleteCrawl-1" + group_fla_values_tok="CompleteCrawl-1" > 0)
GROUP BY feedid HAVING 
  persisted_job_count = 0 AND queued_job_count > 0
```

**Configuration**:
- **Lookback**: 8 days
- **Requirements**: Complete Crawl + Update Existing FLAs
- **Condition**: Job list returning jobs but none processing to completion
- **Excludes**: Procedural feeds

### **Incomplete Runs**
```sql
-- Feed run duration = 0 (didn't complete)
FROM feedrun 4d tomorrow
GROUP BY feedid HAVING 
  feed_run_duration = 0
```

**Configuration**:
- **Lookback**: 4 days
- **Indicates**: Feed didn't complete processing
- **Common Causes**: Timeouts, memory issues, infinite loops

### **Pagination Issues**
```sql
-- Pagination rules not returning results
FROM feedrun 32d 30d as active, 
     feedrun 30d tomorrow as recent, 
     feedrun 3d tomorrow as now
WHERE exclusion_logic
GROUP BY feedid HAVING (
  (STDEV(now.job_link_count)=0 
   AND now.pagination_feed_data_target_hit=0
   AND now.pagination_feed_data_target_miss>0
   AND (AVG(now.job_link_count)%10 = 0 OR AVG(now.job_link_count)%25 = 0)
   AND (AVG(now.job_link_count)/AVG(recent.job_link_count))<0.5)
  OR
  (STDEV(recent.job_link_count)=0
   AND (AVG(recent.job_link_count)%10 = 0 OR AVG(recent.job_link_count)%25 = 0)
   AND recent.pagination_feed_data_target_hit=0
   AND recent.pagination_feed_data_target_miss>0)
)
```

**Configuration**:
- **Lookback**: 3-32 days (tiered)
- **Patterns**: Job counts stuck at multiples of 10/25
- **Edge-triggered**: Cannot use auto-close
- **Indicators**: Pagination target misses with no hits

### **Discarded Jobs**
```sql
-- All jobs being discarded
FROM feedrun 5d tomorrow
WHERE feed_type IN ("agg3","xml") 
  AND feed_processing_duration > 0
GROUP BY job_feed_id HAVING 
  (waldorf_new_discarded_job_count + 
   waldorf_noop_updated_discarded_job_count + 
   waldorf_updated_discarded_job_count) >= 
  (waldorf_new_discarded_job_count + 
   waldorf_noop_updated_discarded_job_count + 
   waldorf_updated_discarded_job_count + 
   waldorf_new_job_count + 
   waldorf_noop_updated_job_count + 
   waldorf_updated_job_count)
```

**Configuration**:
- **Lookback**: 5 days
- **Condition**: Discarded jobs >= total jobs processed
- **Common Causes**: Empty descriptions (ED), empty titles (ET), bad country (BADCNTRY)

### **Data Target Critical**
```sql
-- Missing critical data (DALT: Description, Apply, Location, Title)
FROM feedrun 3d tomorrow
WHERE critical_data_targets_missing
GROUP BY feedid HAVING 
  missing_critical_data_percentage > threshold
```

**Configuration**:
- **Lookback**: 3 days
- **Critical Fields**: Description, Apply method, Location, Title
- **Impact**: Jobs cannot be published without DALT data
- **Threshold**: Varies by data target importance

## XML-Specific Heuristics

### **XML Run Exception**
```sql
-- XML processing failures
FROM feedrun 3d tomorrow
WHERE exclusion_criteria
GROUP BY feedid HAVING 
  run_exception="XML_PROCESSING"=COUNT()
```

**Configuration**:
- **Lookback**: 3 days
- **Pattern**: All runs ending in XML_PROCESSING exception
- **Common Causes**: Malformed XML, invalid characters, encoding issues

### **Invalid XML Character**
```sql
-- Invalid characters causing XML parsing failures
FROM feedrun 1d tomorrow
GROUP BY feedid HAVING 
  invalid_xml_char > last_queued = COUNT()
```

**Configuration**:
- **Lookback**: 1 day
- **Condition**: Invalid XML character more recent than last queued job
- **Resolution**: Client must fix XML formatting

### **XML No Recent Runs**
```sql
-- XML feeds not running for 30+ days but still active
FROM feedhealth 4d today
WHERE feedtype = 'xml'
  AND job_feed_id NOT IN (FROM feedrun 30d today GROUP BY job_feed_id)
  AND (
    job_feed_id IN (FROM adclick2 7d today GROUP BY job_feed_id)
    OR 
    job_feed_id IN (FROM searchablejobs 7d today 
                   WHERE job_visibility_level IN ('jobalert','organic') 
                   GROUP BY job_feed_id)
  )
```

**Configuration**:
- **Lookback**: 30 days for runs, 7 days for activity
- **Conditions**: No runs but has sponsored clicks OR visible jobs
- **Excludes**: Programmatic feeds (extensive FTP exclusion list)

## Advanced Heuristics

### **Data Target Addition**
```sql
-- Detects missing data targets that could be captured
FROM searchablejobs(
  agg_job_id IN (
    FROM waldorulematch 7d tomorrow 
    WHERE ruleid = ${rule_id}
    GROUP BY agg_job_id
  )
) 7d today as flagged_jobs,
searchablejobs as all_jobs
WHERE feed_exclusion_criteria
GROUP BY job_feed_id HAVING 
  distinct(flagged_jobs.jobid) / distinct(all_jobs.jobid) > 0.5
  AND distinct(flagged_jobs.jobid) > 1
```

**Configuration**:
- **Markets**: English and Japanese language jobs
- **Targets**: Salary, job type, expiration date
- **Threshold**: >50% of jobs with keyword matches
- **Analysis**: Uses Waldo rules for keyword detection

### **Job Country/Country Hint Mismatch**
```sql
-- Jobs in wrong country vs feed country hint
FROM searchablejobs(job_country_code NOT IN (${jobcountries})) 7d tomorrow as q1,
     searchablejobs as q2
WHERE feedtype = "agg3" AND sourcetype = "Employer"
  AND feed_country_hint_matches_owning_country
GROUP BY job_feed_id HAVING 
  distinct(q1.agg_job_id) >= distinct(q2.agg_job_id)
```

**Configuration**:
- **Lookback**: 7 days
- **Requirements**: Country Hint FLA active, matching feed owning country
- **Condition**: Jobs in wrong country >= total jobs
- **Feed Types**: Agg3 Employer feeds only

### **Page Hit Limit**
```sql
-- Feeds reaching 1000 page limit
FROM feedrun(job_list_level = 999) 3d today as hits_limit,
     feedrun 3d today as all
WHERE feed_fla_tok != 'HitLimit'
GROUP BY job_feed_id HAVING 
  hits_limit.count() = all.count()
```

**Configuration**:
- **Lookback**: 3 days
- **Condition**: All runs hitting 999 pagination (1000 page limit)
- **Excludes**: Feeds with Hit Limit FLA configured
- **Action**: Review if Hit Limit FLA should be added

## Exclusion Patterns & False Positive Prevention

### **Historical Investigation Exclusions**
```sql
-- Exclude feeds with 3+ previous SHLKs for same issue
job_feed_id NOT IN (
  FROM mechaactions 180d 1d 
  WHERE projectkey = "SHLK" 
    AND action = "update" 
    AND labelstok = "heuristic_name"
    AND actorgroupstok IN ("aggops-analyst", "external-agganalyst-avantica")
  GROUP BY job_feed_id 
  HAVING DISTINCT(issuekey) >= 3
)
```

### **False Positive Exclusions**
```sql
-- Exclude feeds with 2+ false positive closures
job_feed_id NOT IN (
  FROM mechaactions 180d 1d 
  WHERE projectkey = "SHLK" 
    AND labelstok = "heuristic_name"
    AND status = "Closed - SHLK False Positive"
    AND (actorgroupstok IN ("aggops-analyst", "external-agganalyst-avantica") 
         OR actorusername IN ("aggcentraluser"))
  GROUP BY job_feed_id 
  HAVING DISTINCT(issuekey) >= 2
)
```

### **Feed Type Exclusions**
- **Programmatic Feeds**: Extensive FTP URL exclusion list
- **Disabled Feeds**: No hits in feedhealth index
- **Group Definition Feeds**: Some heuristics don't apply
- **Procedural Feeds**: Excluded from specific heuristics

## Monitoring Tools & Dashboards

### **AggMon UI**
- **URL**: `https://aggmon-scorer.sandbox.indeed.net/private/poodlepants/#!/index/heuristics`
- **Purpose**: Manage heuristics, view feed health status
- **Features**: 
  - Enable/disable heuristics
  - Adjust thresholds
  - View historical performance
  - Monitor heuristic effectiveness

### **Key Dashboards**
- **SHLK Conversion Ishbook**: Track investigation success rates
- **New SHLKs by Module**: Daily volume monitoring via IQL Superset
- **Queue Volume Spreadsheet**: Weekly automated tracking
- **Feed Health Charts**: Visual representation of feed status trends

### **Alert Systems**
- **IQL Alerts**: Automatic email notifications for priority modules
- **Slack Integration**: Real-time notifications in `#aggops-health`
- **Priority Escalation**: Automated escalation for critical failures

## Investigation Workflow

### **1. SHLK Ticket Creation**
```
AggMon Heuristic Triggers → SHLK Ticket Created → Label Applied → Routed to AggHealth
```

### **2. Investigation Process**
1. **Accept AFM**: Assign ticket to investigator
2. **Heuristic Analysis**: Follow specific heuristic investigation guide
3. **Root Cause**: Identify feed issue using diagnostic tools
4. **Resolution**: Apply fix or escalate to Feed Maintenance
5. **Verification**: Confirm fix resolves issue
6. **Documentation**: Update ticket with findings and actions

### **3. Resolution Outcomes**
- **Fixed**: Issue resolved, feed returns to healthy state
- **Escalated**: Sent to Feed Maintenance for technical fixes
- **False Positive**: Marked as functioning as expected
- **Deferred**: Scheduled for future investigation

## Feed Health States

### **Health Status Levels**
- **Healthy**: All heuristics passing, feed operating normally
- **Warning**: Minor issues detected, feed still functional
- **Error**: Critical heuristics failing, feed may be impacted
- **Disabled**: Feed intentionally turned off

### **Key Health Metrics**
- **Job Volume Consistency**: Stable job counts over time
- **Success Rate**: Percentage of successful feed runs
- **Data Quality Score**: DALT field completion rates
- **Runtime Performance**: Average feed processing duration
- **Error Rate**: Frequency of heuristic triggers

## Best Practices

### **1. Proactive Monitoring**
- Monitor feed run consistency and job volume trends
- Set up custom alerts for high-priority feeds
- Review weekly health reports for pattern identification
- Track data quality metrics continuously

### **2. Heuristic Configuration**
- Set appropriate thresholds based on feed characteristics
- Consider feed-specific patterns and seasonal variations
- Balance false positive reduction with comprehensive coverage
- Regular review and adjustment of heuristic parameters

### **3. Investigation Efficiency**
- Follow heuristic-specific investigation guides
- Use diagnostic tools for rapid root cause identification
- Document findings and resolutions thoroughly
- Update exclusions for known recurring issues

### **4. Feed Maintenance**
- Regular review of feed definitions and configurations
- Proactive updates for site changes and improvements
- Monitor for emerging patterns requiring new heuristics
- Maintain comprehensive documentation of feed-specific quirks

## Source Documentation Access

This knowledge base was compiled from Indeed's internal Confluence documentation:

### **Primary Sources**

#### **AggHealth AggMon Heuristics**
- **Page ID**: 235832265
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235832265
- **Description**: Comprehensive heuristic definitions and IQL breakdowns
- **Access Command**:
```bash
echo '{"jsonrpc": "2.0", "id": 1, "method": "tools/call", "params": {"name": "confluence_get_page", "arguments": {"page_id": "235832265"}}}' | /opt/homebrew/bin/docker mcp gateway run --transport stdio
```

#### **SHLK 101 for Tech (Demystifying Heuristics and Aggmon)**
- **Page ID**: 235833656
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235833656
- **Description**: Technical overview of heuristics and AggMon system

#### **AggHealth Support Specialists**
- **Page ID**: 235831679
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235831679
- **Description**: Role definitions and responsibilities

#### **Feed Verification for AggHealth Support Specialists**
- **Page ID**: 235832275
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235832275
- **Description**: Feed verification process and workflows

#### **Process for Requesting a New or Updated Heuristic**
- **Page ID**: 235833992
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235833992
- **Description**: Heuristic development and modification process

### **Related Documentation**

#### **Auto Close and Edge-triggered Heuristics**
- **Page ID**: 235834328
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235834328

#### **AggHealth Support Specialist Process for SHLKs**
- **Page ID**: 235832273
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235832273

#### **Training for New AggHealth Support Specialists**
- **Page ID**: 235831562
- **URL**: https://indeed.atlassian.net/wiki/spaces/AggOpsInternal/pages/235831562

### **Search Commands Used**
```bash
# Feed health and monitoring search
echo '{"jsonrpc": "2.0", "id": 1, "method": "tools/call", "params": {"name": "confluence_search", "arguments": {"query": "feed health AggHealth monitoring", "spaces_filter": "AggOpsInternal", "limit": 10}}}' | /opt/homebrew/bin/docker mcp gateway run --transport stdio

# SHLK heuristics search
echo '{"jsonrpc": "2.0", "id": 2, "method": "tools/call", "params": {"name": "confluence_search", "arguments": {"query": "feed health SHLKs heuristics monitoring", "spaces_filter": "AggOpsInternal", "limit": 8}}}' | /opt/homebrew/bin/docker mcp gateway run --transport stdio
```

### **Note on Documentation Updates**
The Confluence documentation is actively maintained and may be updated after this knowledge base was created. Always cross-reference with the live documentation for the most current heuristic definitions and thresholds.

---

This knowledge base provides comprehensive understanding of Indeed's feed health monitoring system and should be referenced for all feed health-related activities, investigations, and system maintenance.
