import { describe, it, expect } from 'vitest'
import { screen } from '@testing-library/react'
import { renderWithTheme } from '@/__tests__/utils/test-utils'
import { testFactories } from '@/__tests__/db/test-factories'
import BoostIntroductionStep from '../boost-introduction-step'

describe('BoostIntroductionStep', () => {
  describe('Rendering with tournament prop', () => {
    it('displays tournament-specific boost counts', () => {
      const tournament = testFactories.tournament({
        id: 'copa-america-2024',
        short_name: 'CA24',
        long_name: 'Copa Am√©rica 2024',
        max_silver_games: 7,
        max_golden_games: 4,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Verify silver boost count
      expect(screen.getByText('Tienes 7 boosts disponibles por torneo')).toBeInTheDocument()

      // Verify golden boost count
      expect(screen.getByText('Tienes 4 boosts disponibles por torneo')).toBeInTheDocument()
    })

    it('displays tournament name in alert when available', () => {
      const tournament = testFactories.tournament({
        id: 'world-cup-2026',
        short_name: 'WC26',
        long_name: 'FIFA World Cup 2026',
        max_silver_games: 8,
        max_golden_games: 5,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Verify tournament name is shown in alert
      expect(screen.getByText(/Configuraci√≥n para FIFA World Cup 2026:/)).toBeInTheDocument()
    })

    it('uses long_name when available, otherwise falls back to short_name', () => {
      const tournamentWithLongName = testFactories.tournament({
        id: 'euro-2024',
        short_name: 'EUR24',
        long_name: 'UEFA Euro 2024',
        max_silver_games: 6,
        max_golden_games: 3,
      })

      const { rerenderWithTheme } = renderWithTheme(
        <BoostIntroductionStep tournament={tournamentWithLongName} />
      )

      expect(screen.getByText(/Configuraci√≥n para UEFA Euro 2024:/)).toBeInTheDocument()

      // Test fallback to short_name when long_name is null
      const tournamentWithoutLongName = testFactories.tournament({
        id: 'test-tournament',
        short_name: 'TST24',
        long_name: null as unknown as string,
        max_silver_games: 6,
        max_golden_games: 3,
      })

      rerenderWithTheme(<BoostIntroductionStep tournament={tournamentWithoutLongName} />)

      expect(screen.getByText(/Configuraci√≥n para TST24:/)).toBeInTheDocument()
    })
  })

  describe('Rendering without tournament prop', () => {
    it('displays 0 boosts when tournament is undefined', () => {
      renderWithTheme(<BoostIntroductionStep />)

      // Verify silver boost count is 0
      expect(screen.getByText('Tienes 0 boosts disponibles por torneo')).toBeInTheDocument()

      // Verify golden boost count is 0 (there should be 2 instances, one for each boost type)
      const zeroBoostTexts = screen.getAllByText('Tienes 0 boosts disponibles por torneo')
      expect(zeroBoostTexts).toHaveLength(2)
    })

    it('does not display tournament name in alert when tournament is undefined', () => {
      renderWithTheme(<BoostIntroductionStep />)

      // Verify tournament configuration line is not present
      expect(screen.queryByText(/Configuraci√≥n para/)).not.toBeInTheDocument()

      // But general info should still be present
      expect(screen.getByText('Puntos Importantes:')).toBeInTheDocument()
    })
  })

  describe('Singular/plural handling', () => {
    it('uses singular "boost disponible" when count is 1', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 1,
        max_golden_games: 1,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Both silver and golden boosts should use singular form
      const singularTexts = screen.getAllByText('Tienes 1 boost disponible por torneo')
      expect(singularTexts).toHaveLength(2)
    })

    it('uses plural "boosts disponibles" when count is 0', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 0,
        max_golden_games: 0,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Both should use plural form even with 0
      const pluralTexts = screen.getAllByText('Tienes 0 boosts disponibles por torneo')
      expect(pluralTexts).toHaveLength(2)
    })

    it('uses plural "boosts disponibles" when count is greater than 1', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 5,
        max_golden_games: 3,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      expect(screen.getByText('Tienes 5 boosts disponibles por torneo')).toBeInTheDocument()
      expect(screen.getByText('Tienes 3 boosts disponibles por torneo')).toBeInTheDocument()
    })

    it('handles mixed singular/plural correctly', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 1,
        max_golden_games: 4,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Silver should be singular
      expect(screen.getByText('Tienes 1 boost disponible por torneo')).toBeInTheDocument()

      // Golden should be plural
      expect(screen.getByText('Tienes 4 boosts disponibles por torneo')).toBeInTheDocument()
    })
  })

  describe('Content structure', () => {
    it('displays main heading and description', () => {
      renderWithTheme(<BoostIntroductionStep />)

      expect(screen.getByText('Multiplica Tus Puntos con Boosts')).toBeInTheDocument()
      expect(screen.getByText('Usa tus boosts estrat√©gicamente en partidos clave')).toBeInTheDocument()
    })

    it('displays silver boost card with correct information', () => {
      renderWithTheme(<BoostIntroductionStep />)

      expect(screen.getByText('Boost Plateado')).toBeInTheDocument()
      expect(screen.getByText('Multiplica √ó 2')).toBeInTheDocument()
      expect(screen.getByText('Duplica tus puntos en el partido que elijas')).toBeInTheDocument()
    })

    it('displays golden boost card with correct information', () => {
      renderWithTheme(<BoostIntroductionStep />)

      expect(screen.getByText('Boost Dorado')).toBeInTheDocument()
      expect(screen.getByText('Multiplica √ó 3')).toBeInTheDocument()
      expect(screen.getByText('Triplica tus puntos en tu partido m√°s importante')).toBeInTheDocument()
    })

    it('displays important points alert with all key information', () => {
      renderWithTheme(<BoostIntroductionStep />)

      expect(screen.getByText('Puntos Importantes:')).toBeInTheDocument()
      expect(
        screen.getByText((content, element) => {
          return (
            element?.tagName === 'TYPOGRAPHY' &&
            content.includes('espec√≠ficos de cada torneo')
          )
        })
      ).toBeInTheDocument()
      expect(
        screen.getByText((content, element) => {
          return (
            element?.tagName === 'TYPOGRAPHY' &&
            content.includes('predicciones de partidos')
          )
        })
      ).toBeInTheDocument()
      expect(
        screen.getByText((content, element) => {
          return (
            element?.tagName === 'TYPOGRAPHY' &&
            content.includes('1 hora antes del partido')
          )
        })
      ).toBeInTheDocument()
    })

    it('displays strategic tip section', () => {
      renderWithTheme(<BoostIntroductionStep />)

      expect(screen.getByText('üí° Consejo Estrat√©gico')).toBeInTheDocument()
      expect(
        screen.getByText('Guarda tus boosts para finales y partidos decisivos donde est√©s m√°s seguro del resultado')
      ).toBeInTheDocument()
    })
  })

  describe('Visual elements', () => {
    it('renders silver boost emoji', () => {
      const { container } = renderWithTheme(<BoostIntroductionStep />)

      // Silver boost emoji is in a Box component
      const silverBoostCard = screen.getByText('Boost Plateado').closest('[class*="MuiCard"]')
      expect(silverBoostCard).toBeInTheDocument()
      expect(silverBoostCard?.textContent).toContain('ü•à')
    })

    it('renders golden boost icon', () => {
      renderWithTheme(<BoostIntroductionStep />)

      // Golden boost uses LocalFireDepartmentIcon
      const goldenBoostCard = screen.getByText('Boost Dorado').closest('[class*="MuiCard"]')
      expect(goldenBoostCard).toBeInTheDocument()

      // Check that the icon is rendered (Material-UI icons render as svg)
      const icon = goldenBoostCard?.querySelector('svg')
      expect(icon).toBeInTheDocument()
    })
  })

  describe('Edge cases', () => {
    it('handles large boost counts correctly', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 99,
        max_golden_games: 50,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      expect(screen.getByText('Tienes 99 boosts disponibles por torneo')).toBeInTheDocument()
      expect(screen.getByText('Tienes 50 boosts disponibles por torneo')).toBeInTheDocument()
    })

    it('handles null max_silver_games and max_golden_games as 0', () => {
      const tournament = testFactories.tournament({
        max_silver_games: null as unknown as number,
        max_golden_games: null as unknown as number,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Nullish coalescing should convert null to 0
      const zeroBoostTexts = screen.getAllByText('Tienes 0 boosts disponibles por torneo')
      expect(zeroBoostTexts).toHaveLength(2)
    })

    it('handles undefined max_silver_games and max_golden_games as 0', () => {
      const tournament = testFactories.tournament({
        max_silver_games: undefined as unknown as number,
        max_golden_games: undefined as unknown as number,
      })

      renderWithTheme(<BoostIntroductionStep tournament={tournament} />)

      // Nullish coalescing should convert undefined to 0
      const zeroBoostTexts = screen.getAllByText('Tienes 0 boosts disponibles por torneo')
      expect(zeroBoostTexts).toHaveLength(2)
    })
  })

  describe('Theme compatibility', () => {
    it('renders correctly with light theme', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 5,
        max_golden_games: 3,
      })

      const { container } = renderWithTheme(<BoostIntroductionStep tournament={tournament} />, {
        theme: 'light',
      })

      expect(container).toBeInTheDocument()
      expect(screen.getByText('Multiplica Tus Puntos con Boosts')).toBeInTheDocument()
    })

    it('renders correctly with dark theme', () => {
      const tournament = testFactories.tournament({
        max_silver_games: 5,
        max_golden_games: 3,
      })

      const { container } = renderWithTheme(<BoostIntroductionStep tournament={tournament} />, {
        theme: 'dark',
      })

      expect(container).toBeInTheDocument()
      expect(screen.getByText('Multiplica Tus Puntos con Boosts')).toBeInTheDocument()
    })
  })
})
